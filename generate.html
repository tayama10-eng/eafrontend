<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EA生成（β）</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <header class="center"><h1>EA生成（β）</h1></header>
  <main class="container" style="max-width:900px">
    <div class="card">
      <h3>OpenAI APIキー（ブラウザにのみ保存）</h3>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <input id="apiKey" type="password" placeholder="sk-..." style="flex:1;min-width:220px"/>
        <button onclick="saveKey()">保存</button>
        <button onclick="clearKey()">削除</button>
      </div>
      <p id="keyStatus" class="muted small">未保存</p>
    </div>

    <div class="card">
      <label>戦略の説明（日本語）</label>
      <textarea id="desc" placeholder="例：USDJPY H1。ATR×1.3でSL、×2.6でTP。…"></textarea>
      <div style="display:flex;gap:10px;margin-top:10px">
        <button onclick="fillSample()">サンプル</button>
        <button onclick="generateEA()">EAを生成</button>
      </div>
      <p id="status" class="muted small"></p>
      <pre id="preview"></pre>
      <div id="dl"></div>
      <p class="muted small">※ キーはブラウザのローカルにのみ保存／サーバ送信しません。まずはデモ口座で検証を。</p>
    </div>
  </main>

<script>
const KEY_NAME="openai_api_key";
function loadKey(){ document.getElementById('keyStatus').textContent = localStorage.getItem(KEY_NAME) ? "保存済み（ブラウザ内）" : "未保存"; }
function saveKey(){ const v=document.getElementById('apiKey').value.trim(); if(!v.startsWith("sk-")){alert("sk-で始まるキーを入れてください");return;} localStorage.setItem(KEY_NAME,v); loadKey(); }
function clearKey(){ localStorage.removeItem(KEY_NAME); loadKey(); }
function fillSample(){
  document.getElementById('desc').value="USDJPY H1。トレンド判定=ADX14>=22。ATR圧縮フィルタ。流動性狩り（下ヒゲ→実体戻り）でロング。SL=ATR1.3倍、TP=ATR2.6倍、BE=ATR1.0倍、トレーリング=ATR1.0倍。Risk=1%。";
}
async function generateEA(){
  const key=localStorage.getItem(KEY_NAME);
  if(!key){ alert("OpenAI APIキーを保存してください"); return; }
  const desc=document.getElementById('desc').value.trim();
  if(!desc){ document.getElementById('status').textContent="説明を入力してください"; return; }
  document.getElementById('status').textContent="生成中…"; document.getElementById('preview').textContent=""; document.getElementById('dl').innerHTML="";
  const prompt=`You are an expert MQL5 developer. Output ONLY a complete, compilable MQL5 Expert Advisor code block, nothing else.
Requirements:
- Write comments in Japanese.
- #property strict, use CTrade.
- Inputs: RiskPercent(0=use FixedLot), FixedLot, Magic, filters if needed.
- Place SL/TP at ATR multipliers if specified; implement BreakEven/Trailing if mentioned.
- Ensure code compiles standalone and has OnInit/OnTick.
- No external includes beyond <Trade/Trade.mqh>.
User description (Japanese):
"""${desc}"""`;
  try{
    const r=await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{ "Content-Type":"application/json","Authorization":"Bearer "+key },
      body:JSON.stringify({ model:"gpt-4o-mini", temperature:0.1, messages:[{role:"user",content:prompt}] })
    });
    if(!r.ok){ throw new Error(await r.text()); }
    const data=await r.json();
    let content=data.choices?.[0]?.message?.content||"";
    const m=content.match(/```(?:mql5|cpp|)?([\s\S]*?)```/i); if(m){ content=m[1].trim(); }
    if(content.length<50){ throw new Error("コードが短すぎます。説明を具体化して再試行してください。"); }
    document.getElementById('preview').textContent=content.slice(0,2000)+(content.length>2000?"\n...（省略）":"");
    const blob=new Blob([content],{type:"text/plain;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download="EA_"+new Date().toISOString().replace(/[:.]/g,"-")+".mq5"; a.textContent="↓ EA（.mq5）をダウンロード";
    document.getElementById('dl').appendChild(a);
    document.getElementById('status').textContent="生成完了。まずはデモ口座で検証を！";
  }catch(e){ document.getElementById('status').textContent="エラー: "+e.message; }
}
loadKey();
</script>
</body>
</html>
